<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Loyalty Fights</title>
  <style>
    :root{--bg:#0f1112;--accent:#ff6b4a;--muted:#9aa0a6;--panel:#0b0c0d;--border:#202224;--danger:#ff3b30}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:var(--bg);color:#fff;line-height:1.3;min-height:100dvh;display:flex;flex-direction:column}
    header.page-head{position:sticky;top:0;background:#111;padding:.6rem .9rem;display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;z-index:10;border-bottom:1px solid #181a1b}
    h2{margin:0;font-size:1.2rem}
    .token-wrap{display:flex;flex:1;gap:.4rem;align-items:center;min-width:220px}
    input,select{padding:.55rem .65rem;font-size:1rem;border-radius:8px;border:1px solid #222;background:#161718;color:#fff;width:100%;}
    input:focus,select:focus,button:focus{outline:2px solid var(--accent);outline-offset:2px}
    button{padding:.65rem .95rem;border-radius:10px;border:0;background:var(--accent);color:#111;font-weight:600;font-size:0.95rem;cursor:pointer;min-width:60px;display:inline-flex;justify-content:center;align-items:center;gap:.3rem}
    button:active{transform:scale(.96)}
    .btn-small{padding:.45rem .55rem;font-size:.8rem;border-radius:8px}
    #status{font-weight:600}
    .pill{background:#161718;padding:.4rem .7rem;border-radius:999px;border:1px solid #222;font-size:.75rem}
    .muted{color:var(--muted)}
  main{flex:1;display:flex;flex-direction:column;gap:.9rem;padding:.8rem;}
  .sidebar{width:100%;max-height:calc(100dvh - 220px);overflow:auto;background:var(--panel);padding:.6rem .65rem;border-radius:14px;border:1px solid var(--border);}
    .fightItem{padding:.55rem .6rem;border-radius:10px;margin:.35rem 0;background:#121314;border:1px solid #18191a;cursor:pointer;display:flex;flex-direction:column;gap:.4rem}
    .fightItem:hover{background:#18191b}
    .fightButtons{display:grid;grid-template-columns:repeat(auto-fit,minmax(54px,1fr));gap:.35rem}
    .fightButtons button{font-size:.7rem;padding:.45rem .4rem}
    .section-actions{flex:1;display:flex;flex-direction:column;gap:.9rem}
    .action-block{background:var(--panel);padding:.7rem .8rem;border-radius:14px;border:1px solid var(--border);display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
    .action-block h3{margin:0 0 .3rem;font-size:.9rem;font-weight:600;color:#fff;width:100%;}
    .feedback{margin-top:.4rem;color:#cfe7d8;font-size:.85rem;min-height:1.2rem}
    @media (max-width:800px){
      main{padding:.6rem}
      .sidebar{max-height:none}
      header.page-head{padding:.55rem .7rem}
      h2{font-size:1.05rem}
    }
    @media (max-width:500px){
      .fightButtons{grid-template-columns:repeat(auto-fit,minmax(46px,1fr))}
      button{padding:.55rem .8rem;font-size:.85rem}
      .btn-small{padding:.35rem .45rem;font-size:.65rem}
      input,select{font-size:.95rem}
    }
  </style>
  <!--
    Set `window.SERVER_ORIGIN` here to point admin clients at your deployed admin server.
    Example (uncomment and edit):
      <script>window.SERVER_ORIGIN = 'https://loyalty-fights.onrender.com'</script>
    If left unset, the page will default to the same origin it's served from (useful for
    local testing when running the server on the same machine).
  -->

  <!-- If hosting admin on its own Render service, remove hard-coded SERVER_ORIGIN so it uses same origin. -->
  <!--<script>window.SERVER_ORIGIN = 'https://loyalty-fights.onrender.com'</script>-->
</head>
<body>

  <header class="page-head">
    <h2>Admin Controls</h2>
    <div class="token-wrap">
      <input id="tokenInput" placeholder="admin token" aria-label="Admin token">
      <button id="connectBtn" title="Connect WebSocket">Connect</button>
    </div>
    <div class="pill muted">Status: <span id="status">disconnected</span></div>
  </header>
  <div class="muted" style="padding:.3rem .85rem 0">Open with ?token=YOURTOKEN to auto-connect.</div>

  <main>
    <div class="section-actions">
      <div class="action-block" aria-labelledby="liveControls">
        <h3 id="liveControls">Live Index</h3>
        <input id="idx" type="number" min="0" value="0" style="max-width:100px" aria-label="Live match index">
        <button id="prev" class="btn-small" title="Previous match">◀ Prev</button>
        <button id="next" class="btn-small" title="Next match">Next ▶</button>
        <button id="setCurrent">Set Current</button>
        <div class="pill muted" style="margin-left:auto">Current: <span id="currentDisplay">-</span> / <span id="totalDisplay">-</span></div>
      </div>
      <div class="action-block" aria-labelledby="newFightControls">
        <h3 id="newFightControls">Card Management</h3>
        <button id="newFightBtn" style="background:#222;color:#fff" title="Create new fight card">- New fight card</button>
      </div>
      <div class="action-block" aria-labelledby="winnerControls">
        <h3 id="winnerControls">Winner / Info</h3>
        <select id="side" style="max-width:110px" aria-label="Winner side"><option value="a">Red (A)</option><option value="b">Blue (B)</option></select>
        <button id="setWinner">Set Winner</button>
        <button id="setDraw" class="btn-small" title="Draw">Draw</button>
        <button id="clearWinner" class="btn-small" title="Clear winner">Clear</button>
        <button id="setStandby" class="btn-small" title="Pause display">Standby</button>
        <button id="clearStandby" class="btn-small" title="Resume display">Resume</button>
        <button id="showInfo" class="btn-small" title="Show event info">Show Info</button>
        <button id="clearInfo" class="btn-small" title="Hide event info">Hide Info</button>
      </div>
      <div class="sidebar" id="fightList" aria-label="Fight list">
        <div class="muted" style="font-size:.75rem">Tap a fight to make it current</div>
        <!-- Fight items injected here -->
      </div>
      <div class="feedback" id="feedback" aria-live="polite"></div>
    </div>
  </main>

  <div class="feedback" id="feedback" aria-live="polite"></div>

  <script>
  // simplified admin UI with explicit connect and clear feedback
  const urlToken = new URLSearchParams(location.search).get('token') || '';
  const tokenInput = document.getElementById('tokenInput');
  const statusEl = document.getElementById('status');
  const feedback = document.getElementById('feedback');
  const currentDisplay = document.getElementById('currentDisplay');
  const totalDisplay = document.getElementById('totalDisplay');
  const idxEl = document.getElementById('idx');

  tokenInput.value = urlToken;

  let ws = null;
  let state = null;

  function setStatus(s){ statusEl.textContent = s; }
  function showFeedback(msg, ok=true){ feedback.textContent = msg; feedback.style.color = ok? '#cfe7d8':'#f6b3b3'; }

  function connect(){
    const token = tokenInput.value.trim();
    if(!token){ showFeedback('Please enter a token first', false); return; }
    if(ws){ ws.close(); ws = null; }
    // use SERVER_ORIGIN when deployed; fall back to current host
    const origin = window.SERVER_ORIGIN || (location.protocol + '//' + location.host);
    const scheme = origin.startsWith('https:')? 'wss':'ws';
    const wsTarget = scheme + '://' + origin.replace(/^https?:\/\//, '');
    ws = new WebSocket(wsTarget);
  // expose for debugging
  window.__adminWs = ws;
  console.log('admin: connecting websocket to', wsTarget);
    ws.addEventListener('open', ()=> setStatus('connected (ws)') );
    ws.addEventListener('close', ()=> setStatus('disconnected') );
    ws.addEventListener('error', ()=> setStatus('error') );
    ws.addEventListener('message', (ev)=>{
      try{ const msg = JSON.parse(ev.data); if(msg.type === 'state'){ state = msg.state; updateUIFromState(); } }
      catch(e){}
    });
    showFeedback('Connecting...');
  }

  function updateUIFromState(){
    if(!state) return;
    idxEl.value = (state.current!=null)? state.current : 0;
    currentDisplay.textContent = (state.current!=null)? state.current : '-';
    totalDisplay.textContent = (Array.isArray(state.fights)? state.fights.length : '-');
    showFeedback('State updated', true);
    renderFightList();
  }

  function renderFightList(){
    const container = document.getElementById('fightList');
    // remove old items except the header line
    container.querySelectorAll('.fightItem').forEach(n=>n.remove());
    if(!state || !Array.isArray(state.fights)) return;
    state.fights.forEach((f, i)=>{
      const div = document.createElement('div'); div.className = 'fightItem';
      const title = document.createElement('div'); title.innerHTML = `<strong>#${i+1}</strong> ${escapeHtml(f.a)} vs ${escapeHtml(f.b)} <span class="muted">(${escapeHtml(f.klass||'')})</span>`;
      div.appendChild(title);
      const btns = document.createElement('div'); btns.className = 'fightButtons';
      const aBtn = document.createElement('button'); aBtn.textContent = 'A'; aBtn.className='smallBtn'; aBtn.addEventListener('click', (e)=>{ e.stopPropagation(); sendAction({type:'setWinner', index:i, side:'a'}); });
      const bBtn = document.createElement('button'); bBtn.textContent = 'B'; bBtn.className='smallBtn'; bBtn.addEventListener('click', (e)=>{ e.stopPropagation(); sendAction({type:'setWinner', index:i, side:'b'}); });
  const dBtn = document.createElement('button'); dBtn.textContent = 'Draw'; dBtn.className='smallBtn'; dBtn.addEventListener('click', (e)=>{ e.stopPropagation(); sendAction({type:'setWinner', index:i, side:'draw'}); });
      const clr = document.createElement('button'); clr.textContent='Clear'; clr.className='smallBtn'; clr.addEventListener('click', (e)=>{ e.stopPropagation(); sendAction({type:'clearWinner', index:i}); });
    const focus = document.createElement('button'); focus.textContent='Show'; focus.className='smallBtn'; focus.addEventListener('click', (e)=>{ e.stopPropagation(); sendAction({type:'setCurrent', index:i}); });
    const remove = document.createElement('button'); remove.textContent='Remove'; remove.className='smallBtn'; remove.addEventListener('click', async (e)=>{ e.stopPropagation(); if (confirm('Remove this fight?')){ const r = await sendAction({type:'deleteFight', index:i}); if (r && r.ok){ try{ const s = await fetch('/state'); if (s.ok){ state = await s.json(); updateUIFromState(); } }catch(_){} } }});
  btns.appendChild(aBtn); btns.appendChild(bBtn); btns.appendChild(dBtn); btns.appendChild(clr); btns.appendChild(focus); btns.appendChild(remove);
      div.appendChild(btns);
      div.addEventListener('click', ()=>{ idxEl.value = i; sendAction({type:'setCurrent', index:i}); });
      container.appendChild(div);
    });
  }

  function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  async function sendAction(payload){
    const token = tokenInput.value.trim();
    if(!token){ showFeedback('Missing token', false); return; }
    // try websocket admin wrapper
    try{
      // Avoid double-processing for createFight: only POST for that action
      if(payload.type !== 'createFight' && ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({ type:'admin', token, payload }));
      }
    }catch(e){ /* ignore ws send errors */ }
    // always POST for immediate feedback and server-side validation
    try{
      const target = (window.SERVER_ORIGIN || '') + '/admin/action?token=' + encodeURIComponent(token);
      // attach an idempotency key for create actions
      if (payload.type === 'createFight' && !payload.rid){
        try{ payload.rid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('rid_'+Date.now()+'_'+Math.random().toString(36).slice(2)); }catch(_){ payload.rid = 'rid_'+Date.now(); }
      }
      const res = await fetch(target, { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(payload) });
      if(res.ok){ const j = await res.json(); showFeedback('OK: '+ (j.ok? 'action applied':'response received'), true); return j; }
      else { const text = await res.text(); showFeedback('Server error: '+res.status+' '+text, false); return null; }
    }catch(e){ showFeedback('Network error: '+e.message, false); return null; }
  }

  document.getElementById('connectBtn').addEventListener('click', ()=> connect());

  document.getElementById('setCurrent').addEventListener('click', ()=>{
    const index = parseInt(idxEl.value||'0',10) || 0; sendAction({ type:'setCurrent', index });
  });
  document.getElementById('prev').addEventListener('click', ()=>{
    const val = Math.max(0, (parseInt(idxEl.value||'0',10)-1)); idxEl.value = val; sendAction({ type:'setCurrent', index:val });
  });
  document.getElementById('next').addEventListener('click', ()=>{
    const val = (parseInt(idxEl.value||'0',10)+1); idxEl.value = val; sendAction({ type:'setCurrent', index:val });
  });

  document.getElementById('setWinner').addEventListener('click', ()=>{
    const index = parseInt(idxEl.value||'0',10) || 0; const side = document.getElementById('side').value; sendAction({ type:'setWinner', index, side });
  });
  document.getElementById('setDraw').addEventListener('click', ()=>{
    const index = parseInt(idxEl.value||'0',10) || 0; sendAction({ type:'setWinner', index, side:'draw' });
  });
  document.getElementById('clearWinner').addEventListener('click', ()=>{
    const index = parseInt(idxEl.value||'0',10) || 0; sendAction({ type:'clearWinner', index });
  });
  document.getElementById('setStandby').addEventListener('click', ()=>{
    sendAction({ type:'setStandby', on:true });
  });
  document.getElementById('clearStandby').addEventListener('click', ()=>{
    sendAction({ type:'setStandby', on:false });
  });
  document.getElementById('showInfo').addEventListener('click', ()=>{
    sendAction({ type:'setInfoVisible', on:true });
  });
  document.getElementById('clearInfo').addEventListener('click', ()=>{
    sendAction({ type:'setInfoVisible', on:false });
  });

    // New fight modal logic
    const modalHtml = `
      <div id="fightModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;font-size:16px">
        <div style="background:#111;padding:1rem 1.1rem;border-radius:16px;width:clamp(300px,90%,480px);border:1px solid #222;max-height:90vh;overflow:auto;font-family:Segoe UI,Arial,sans-serif">
          <h3 style="margin:.2rem 0 1rem;font-size:1.05rem">Create New Fight</h3>
          <form id="fightForm" style="display:flex;flex-direction:column;gap:.75rem">
            <div style="display:flex;flex-direction:column;gap:.35rem">
              <label class="muted">Division / Klass</label>
              <input name="klass" placeholder="e.g. Junior C" autocomplete="off">
            </div>
            <div style="display:flex;flex-direction:column;gap:.35rem">
              <label class="muted">Weight class</label>
              <input name="weight" placeholder="e.g. 67 kg" autocomplete="off">
            </div>
            <fieldset style="border:1px solid #222;border-radius:10px;padding:.7rem;display:flex;flex-direction:column;gap:.55rem">
              <legend style="padding:0 .4rem;font-size:.8rem;color:var(--muted)">Fighter A</legend>
              <input name="a" placeholder="Name" required autocomplete="off">
              <input name="aGym" placeholder="Gym / Club" autocomplete="off">
            </fieldset>
            <fieldset style="border:1px solid #222;border-radius:10px;padding:.7rem;display:flex;flex-direction:column;gap:.55rem">
              <legend style="padding:0 .4rem;font-size:.8rem;color:var(--muted)">Fighter B</legend>
              <input name="b" placeholder="Name" required autocomplete="off">
              <input name="bGym" placeholder="Gym / Club" autocomplete="off">
            </fieldset>
            <div style="display:flex;gap:.6rem;justify-content:flex-end;margin-top:.4rem">
              <button type="button" id="cancelFight" style="background:#222;color:#eee">Cancel</button>
              <button type="submit" id="createFightBtn">Create fight</button>
            </div>
          </form>
        </div>
      </div>`;
    function openFightModal(){
      if(document.getElementById('fightModal')) return; // already open
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const modal = document.getElementById('fightModal');
      const form = document.getElementById('fightForm');
      modal.addEventListener('click', e=>{ if(e.target === modal) closeFightModal(); });
      document.getElementById('cancelFight').addEventListener('click', ()=> closeFightModal());
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        if(!data.a || !data.b){ showFeedback('Enter both fighter names', false); return; }
        const resp = await sendAction({ type:'createFight', data });
        closeFightModal();
        if (resp && resp.fight){
          // optimistic local update so it appears instantly
          if (!state) state = { fights: [], current: 0 };
          state.fights.push(resp.fight);
          updateUIFromState();
        } else {
          // fallback to full state fetch if response didn't include fight
          try{ const r = await fetch('/state'); if(r.ok){ state = await r.json(); updateUIFromState(); } }catch(_){ }
        }
      });
    }
    function closeFightModal(){ const m = document.getElementById('fightModal'); if(m) m.remove(); }
    document.getElementById('newFightBtn').addEventListener('click', openFightModal);

  // auto-connect if token provided in URL
  if(tokenInput.value) connect();

  // fetch initial state so the page shows accurate values even before ws connects
  (async ()=>{
    try{ const r = await fetch('/state'); if(r.ok){ state = await r.json(); updateUIFromState(); } }catch(e){}
  })();

  </script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thai Gala - Fight Card</title>
  <link rel="stylesheet" href="styles.css">
  <!--
    If you deploy the static site to GitHub Pages and run the admin server elsewhere,
    set the server origin here so clients connect to the deployed server for
    real-time admin updates.
    Example (uncomment and edit):
      <script>window.SERVER_ORIGIN = 'https://loyalty-fights.onrender.com'</script>
    Leave commented to default to the page's own origin (useful for local testing).
  -->
</head>
<body>
  <!-- header removed -->

  <main class="fight-main">
    <div class="logo-wrap"><img id="logoImage" src="loyalty_fights.png" alt="Loyalty Fights"></div>
  <h2 class="section-title">Fight Card</h2>
    <div class="now-strip">
      <div>Nu:</div>
      <div id="nowDisplay" class="now-match">—</div>
    </div>
  <section id="fightList" class="cards fight-cards" aria-live="polite"></section>

    
  </main>

  <section class="loyalty-footer">
    <p>Vill du veta mer om Loyalty Muay Thai?<br>
    Besök vår hemsida: <a href="https://www.loyaltymuaythai.se" target="_blank">www.loyaltymuaythai.se</a></p>
    <p>eller följ oss på Instagram: <a href="https://instagram.com/loyaltymuaythaiofficiell" target="_blank">@loyaltymuaythaiofficiell</a></p>
  </section>

  <footer class="site-footer">
    <p>&copy; <span id="year"></span> Loyalty Fights #1</p>
  </footer>

  <!-- QR modal removed -->

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <!-- SheetJS for .xlsx/.xls parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="fightcard.js"></script>
  <script>
    // Viewer websocket client: listens for server state and admin broadcasts
    (function(){
      // SERVER_ORIGIN can be set by a hosting deploy to point clients at the public server
      // Example: <script>window.SERVER_ORIGIN='https://loyalty-fights.onrender.com'</script>
      const origin = window.SERVER_ORIGIN || (location.protocol + '//' + location.host);
      const proto = origin.startsWith('https') ? 'wss' : 'ws';
      // For ws we need the host/port part without https://
      const wsTarget = proto + '://' + origin.replace(/^https?:\/\//, '');
  const ws = new WebSocket(wsTarget);
      ws.addEventListener('open', ()=> console.log('ws open'));
      ws.addEventListener('message', (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          function normalizeIndex(raw, len){
            if (typeof raw !== 'number') return raw;
            // if raw fits 0-based index, use it
            if (raw >= 0 && raw < len) return raw;
            // if raw looks like 1-based (1..len), convert to 0-based
            if (raw >= 1 && raw <= len) return raw - 1;
            // otherwise clamp
            return Math.max(0, Math.min(len-1, raw));
          }

          if (msg.type === 'state' && msg.state){
            // initialize fights and current if provided
            if (Array.isArray(msg.state.fights) && msg.state.fights.length){
              // overwrite local fights array safely
              window._fights.length = 0;
              msg.state.fights.forEach(f=> window._fights.push(f));
            }
            if (typeof msg.state.current === 'number') {
              current = normalizeIndex(msg.state.current, window._fights.length);
            }
            renderList(); updateNow();
            // send ack for this broadcast so server can track which clients applied it
            try{ if (typeof msg.broadcastId === 'number') ws.send(JSON.stringify({ type: 'ack', broadcastId: msg.broadcastId })); }catch(e){}
          }
          // admin messages mirror the action payloads
          if (msg.type === 'setCurrent'){
            current = normalizeIndex(msg.index, window._fights.length); renderList(); updateNow();
          }
          if (msg.type === 'setWinner'){
            const f = window._fights[msg.index]; if (f) f.winner = msg.side; renderList();
          }
          if (msg.type === 'clearWinner'){
            const f = window._fights[msg.index]; if (f) delete f.winner; renderList();
          }
        }catch(e){console.warn('ws parse',e)}
      });

      // Poll the repository's raw fights.json as a fallback so GitHub Pages
      // viewers update when the server commits changes to the repo.
      // This allows the live site to reflect admin commits quickly without
      // requiring a public WebSocket server.
      const rawFightsUrl = 'https://raw.githubusercontent.com/AlexandraHopstadius/Loyalty-Fights/main/fights.json';
      let __lastRaw = null;
      async function pollRawFights(){
        try{
          // append a timestamp to bypass aggressive CDN caching
          const url = rawFightsUrl + '?t=' + Date.now();
          const r = await fetch(url, { cache: 'no-store' });
          if(!r.ok) return;
          const txt = await r.text();
          if(txt && txt !== __lastRaw){
            __lastRaw = txt;
            try{
              const j = JSON.parse(txt);
              // repo may contain either { fights, current } or an array
              const fightsArr = Array.isArray(j) ? j : (Array.isArray(j.fights) ? j.fights : null);
              if(fightsArr){
                window._fights.length = 0; fightsArr.forEach(f=> window._fights.push(f));
              }
              if(j && typeof j.current === 'number') current = j.current;
              renderList(); updateNow();
              // expose last successful poll time for debugging
              window.__lastPoll = Date.now();
            }catch(e){ console.warn('parse raw fights', e); }
          }
        }catch(e){ /* ignore network errors */ }
      }
      // poll every 5s; you can increase/decrease as desired
      setInterval(pollRawFights, 5000);
      pollRawFights();
      // expose for debugging and allow manual force-sync from the console or a button
      window.pollRawFights = pollRawFights;
      window.__lastRaw = __lastRaw;
    })();
  </script>

  <style>
    /* small debug button visible in the corner for admins */
    #debugSyncBtn{position:fixed;right:12px;bottom:12px;background:#ff6b4a;color:#111;border:none;padding:8px 10px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.4);cursor:pointer;z-index:9999}
    #debugSyncInfo{position:fixed;right:12px;bottom:56px;max-width:360px;background:rgba(0,0,0,.8);color:#ddd;padding:8px;border-radius:8px;font-size:12px;z-index:9999;display:none}
  </style>
  <div id="debugSyncInfo" aria-hidden="true"></div>
  <button id="debugSyncBtn" title="Force poll raw fights">Force sync</button>
  <script>
    (function(){
      const btn = document.getElementById('debugSyncBtn');
      const info = document.getElementById('debugSyncInfo');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        info.style.display='block'; info.textContent = 'Fetching raw fights...';
        try{
          await (window.pollRawFights ? window.pollRawFights() : Promise.reject(new Error('pollRawFights not available')));
          info.textContent = 'Fetch complete. Last raw length: ' + (window.__lastRaw ? window.__lastRaw.length : 0);
        }catch(e){ info.textContent = 'Fetch failed: '+ (e && e.message ? e.message : e); }
        setTimeout(()=> info.style.display='none', 5000);
      });
    })();
  </script>
</body>
</html>